version: 2
jobs:
  build:
    environment:
      SHORT_GIT_HASH: $(echo $CIRCLE_SHA1 | cut -c -7)
    docker:
      - image: circleci/ubuntu-server:trusty-latest
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.07.0-ce"
            curl -L -o /tmp/docker-$VER.tgz https://download.docker.com/linux/static/test/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin

      # build and push Docker image
      - run:
          name: Build trinityCore binaries
          command: |
            echo Building with $CIRCLE_BRANCH
            mkdir artifacts
            #docker run -it --rm -v "$PWD/artifacts":/artifacts timothystewart6/trinitycore-docker -r "https://github.com/timothystewart6/BotsPlusPlus.git" -b $CIRCLE_BRANCH
            ## testing
            mkdir -p artifacts/bin
            mkdir -p artifacts/etc
            touch artifacts/bin/authserver
            touch artifacts/bin/worldserver
            touch artifacts/etc/worldserver.conf.dist
            touch artifacts/etc/authserver.conf.dist
            ## testing
      - run:
          name: Build & Push Docker Image
          command: |
            # worldserver
            cp artifacts/bin/worldserver docker/worldserver/
            mkdir docker/worldserver/etc
            cp artifacts/etc/worldserver.conf.dist docker/worldserver/etc
            # authserver
            cp artifacts/bin/authserver docker/authserver/
            mkdir docker/authserver/etc
            cp artifacts/etc/authserver.conf.dist docker/authserver/etc
            cd docker/authserver
            export REPO=$DOCKER_USERNAME/$DOCKER_BOTSPLUSPLUS_AUTHSERVER
            export TAG=latest
            echo $REPO:$TAG:$SHORT_GIT_HASH
            docker build -f Dockerfile -t $REPO:$SHORT_GIT_HASH .
            docker tag $REPO:$SHORT_GIT_HASH $REPO:$TAG
            docker tag $REPO:$SHORT_GIT_HASH $REPO:$CIRCLE_BUILD_NUM
            docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
            docker push $REPO